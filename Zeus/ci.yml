name: CI — Lint & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      # ---------------------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 2. Set up Python
      # ---------------------------------------------------------------
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      # ---------------------------------------------------------------
      # 3. Install dependencies
      # ---------------------------------------------------------------
      - name: Install runtime + dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 pytest

      # ---------------------------------------------------------------
      # 4. Black — format check (no mutations, just exit code)
      # ---------------------------------------------------------------
      - name: Check formatting with Black
        run: |
          black --check --line-length 100 app.py src/ config/

      # ---------------------------------------------------------------
      # 5. Flake8 — lint
      # ---------------------------------------------------------------
      - name: Lint with Flake8
        run: |
          flake8 app.py src/ --max-line-length 100 --extend-ignore E203,W503 --exclude .venv,__pycache__,.github

      # ---------------------------------------------------------------
      # 6. Pytest — unit tests
      # ---------------------------------------------------------------
      - name: Run unit tests
        run: |
          python -m pytest src/tests/ -v --tb=short
